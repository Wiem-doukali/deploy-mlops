name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build and Push Docker"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Trigger Render deployment
      run: |
        curl -X POST https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}
    
    - name: Wait for deployment
      run: |
        echo "‚è≥ D√©ploiement en cours sur Render..."
        sleep 30
        echo "‚úÖ D√©ploiement compl√©t√©"
    
    - name: Test deployed API
      run: |
        for i in {1..5}; do
          if curl -f https://medical-api-v1.onrender.com/health; then
            echo "‚úÖ API is healthy"
            exit 0
          fi
          echo "‚è≥ Attempt $i/5..."
          sleep 10
        done
        exit 1
    
    - name: Notify success
      if: success()
      run: echo "üéâ D√©ploiement r√©ussi!"
    
    - name: Notify failure
      if: failure()
      run: echo "‚ùå D√©ploiement √©chou√©"